#!/usr/bin/env python3

# This script generates plots for scaling studies. Use it with CSV profile
# data generated by -tdy_timers.

import math
import pandas as pd
from optparse import OptionParser

def usage():
    print('tdyperfplot: Usage:')
    print('tdyperfplot [options] <profile1.csv> <profile2.csv> ... <profileN.csv>\n')
    print('Options:')
    print('  -e e1,e2,...,eN: Plot measurements for events e1..eN (default: plot total time)')
    exit()

def extract_metadata(prof_df):
    md_row = None
    md_names = None
    md = {}
    md_frame = prof_df.tail(3)
    for i, s in md_frame.iterrows():
        if s['Stage Name'] == 'METADATA':
            md_row = i
        elif md_row:
            if not md_names:
                md_names = []
                names = s.to_list()
                for name in names:
                    md_names.append(name)
            else:
                mdata = s.to_list()
                for i, val in enumerate(mdata):
                    if not (isinstance(val, float) and math.isnan(val)):
                        md[md_names[i]] = val
    prof_df = prof_df[:-3]
    return prof_df, md

def plot_profiles(files, events):
    # Gather throughput data for the plot.
    labels = []
    x = [] # time (log axis)
    y = [] # throughput = (# cells) / time
    for f in files:
        # Read the profile into a dataframe.
        prof = pd.read_csv(f)
        prof, md = extract_metadata(prof)

        Nx, Ny, Nz = int(md['Nx']), int(md['Ny']), int(md['Nz'])
        num_cells = Nx * Ny * Nz

        if len(events) > 0:
            for e in events:
                t_e = prof.query("'Event Name' == '%s'"%e)['Time'].sum()
                x.append(t_e)
                y.append(num_cells/t_e)
                labels.append('%s(%dx%dx%d)'%(e, Nx, Ny, Nz))
        else: # total time
            print(prof.query("'Event Name' == 'summary'"))
            t_tot = prof.query("'Event Name' == 'summary'")['Time'].sum()
            x.append(t_tot)
            y.append(num_cells/t_tot)
            labels.append('Total(%dx%dx%d)'%(Nx, Ny, Nz))
    print(labels, x, y)

def main():
    import sys
    if len(sys.argv) < 2:
        usage()

    parser = OptionParser()
    parser.add_option("-e", "--events", dest="events", default=[],
                      help="Events to plot")

    options, args = parser.parse_args()
    if ',' in options.events:
        events = options.events.split(',')
    else:
        events = options.events
    files = args

    if len(files) < 1:
      print("tdyperfplot: need at least one profile.")
      exit()

    plot_profiles(files, events)

if __name__ == '__main__':
    main()
